name: Submit Verifiable Builds

on:
  push:
    tags:
      - "*-v*"

jobs:
  submit:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - name: Install Foundry (cast)
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: stable
      - name: Submit verifiable build
        env:
          # Match the local test script environment.
          API_URL: ${{ secrets.VERIFIABLE_BUILDS_BASE_URL }}
          PRIVATE_KEY: ${{ secrets.VERIFIABLE_BUILDS_PRIVATE_KEY }}
          # Optional: JSON array string, e.g. ["sha256:abc...","sha256:def..."]
          VERIFIABLE_BUILD_DEPENDENCIES_JSON: ${{ secrets.VERIFIABLE_BUILD_DEPENDENCIES_JSON }}
          REPO_URL: https://github.com/${{ github.repository }}
        run: |
          set -euo pipefail

          tag="${GITHUB_REF_NAME}"
          client="${tag%%-v*}"
          if [[ -z "$client" || "$client" == "$tag" ]]; then
            echo "Unable to parse client from tag: $tag (expected <client>-v<version>)"
            exit 1
          fi

          cfg=".github/verifiable-builds/clients.json"
          if [[ ! -f "$cfg" ]]; then
            echo "Missing config: $cfg"
            exit 1
          fi

          dockerfile_path="$(jq -r --arg c "$client" '.[$c].dockerfile_path // empty' "$cfg")"
          build_context_path="$(jq -r --arg c "$client" '.[$c].build_context_path // empty' "$cfg")"

          if [[ -z "$dockerfile_path" || -z "$build_context_path" ]]; then
            echo "Unknown client '$client'. Add it to $cfg to enable verifiable builds."
            exit 1
          fi

          if [[ ! -f "$dockerfile_path" ]]; then
            echo "Dockerfile not found at path: $dockerfile_path"
            exit 1
          fi

          # Match the local test script behavior.
          : "${API_URL:?missing secret VERIFIABLE_BUILDS_BASE_URL}"
          : "${PRIVATE_KEY:?missing secret VERIFIABLE_BUILDS_PRIVATE_KEY}"

          PRODUCT="compute"
          WALLET_ADDRESS="$(cast wallet address --private-key "$PRIVATE_KEY" 2>/dev/null)"
          EXPIRY="$(($(date +%s) + 3600))"

          # Domain: {name: "EigenCloud Billing API", version: "1"}
          # Message: BillingAuth{product: "compute", expiry: <timestamp>}
          TYPED_DATA='{"types":{"EIP712Domain":[{"name":"name","type":"string"},{"name":"version","type":"string"}],"BillingAuth":[{"name":"product","type":"string"},{"name":"expiry","type":"uint256"}]},"primaryType":"BillingAuth","domain":{"name":"EigenCloud Billing API","version":"1"},"message":{"product":"'"$PRODUCT"'","expiry":'"$EXPIRY"'}}'

          SIGNATURE="$(cast wallet sign --data --private-key "$PRIVATE_KEY" "$TYPED_DATA" 2>/dev/null)"

          deps="${VERIFIABLE_BUILD_DEPENDENCIES_JSON:-[]}"
          if ! echo "$deps" | jq -e . >/dev/null 2>&1; then
            echo "VERIFIABLE_BUILD_DEPENDENCIES_JSON must be valid JSON (e.g. [] or [\"sha256:...\"])"
            exit 1
          fi

          # Resolve the commit SHA the tag points to (works for annotated tags too).
          git_ref="$(git rev-list -n 1 "$tag")"

          body="$(jq -n \
            --arg repo_url "$REPO_URL" \
            --arg git_ref "$git_ref" \
            --arg dockerfile_path "$dockerfile_path" \
            --arg build_context_path "$build_context_path" \
            --argjson dependencies "$deps" \
            '{repo_url:$repo_url, git_ref:$git_ref, dockerfile_path:$dockerfile_path, build_context_path:$build_context_path, dependencies:$dependencies}')"

          echo "Submitting verifiable build: client=$client tag=$tag repo=$REPO_URL ref=$git_ref dockerfile=$dockerfile_path context=$build_context_path"

          curl -fsS -X POST "${API_URL%/}/builds" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${SIGNATURE}" \
            -H "X-eigenx-expiry: ${EXPIRY}" \
            -H "X-Account: ${WALLET_ADDRESS}" \
            --data "$body"

